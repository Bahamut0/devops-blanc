name: Devops-Blanc

on:
  # repository_dispatch:
  #   types: [create-pull-request]

  push:
    # branches-ignore:
    #   - main
    branches:
      - feature-*
      - features
      
        

permissions:
  contents: write
  pull-requests: write

jobs:

  #   ##################################################################
  #   # Job 1 Créer une pull request pour la branche principale features #
  #   ##################################################################

  createPullRequest:
    runs-on: ubuntu-latest
    # if: startsWith(github.ref, 'refs/heads/feature-')
    if: contains( github.ref, 'feature-' )
    steps:
      - uses: actions/checkout@v3
      - name: Create report file
        run: date +%s > report.txt
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: Add report file
          committer: Bahamut0 <Bahamut0@users.noreply.github.com>
          body: |
            New report
            - Contains *today's* date
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          title: 'Changement sur la branche features'
          labels: feature, automated pr
          assignees: Bahamut0
          reviewers: Bahamut0
          # milestone: 1
          branch: features



    ##############################################################
    # JOB 2 - Build l'env python et effectuer les tests unitaires #
    ##############################################################

  build_and_test:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    # if: github.ref == 'refs/heads/features'
    steps:

    ################################
    # Checkout #
    ################################
    - name: Checkout - Récuparation du projet
      uses: actions/checkout@v4

    - name: Récupération de la branche courante (base)
      run: echo ${{ github.ref }} 

    ################################
    # Python #
    ################################

    - name: Installation de Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'


    ################################
    # Tests   #
    ################################

    - name: Rendre les fichiers sh exécutable
      run: chmod u+x scripts/*

    - name: Génération de la doc main.md
      run: scripts/mkdoc.sh

    - name: Tests unitaires
      run: scripts/mktest.sh


  # pull_request_features :
  #   needs: build_and_test
  #   runs-on: ubuntu-latest
  #   # if: startsWith(github.ref, 'refs/heads/feature-')
  #   # if: github.ref == 'refs/heads/features'
  #   steps:

  #   # recupération du repository
  #   - name: git checkout
  #     uses: actions/checkout@v3
  #     with:
  #       token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  #       fetch-depth: 0
    
  #   - name: Récupération de la branche courante (base)
  #     run: echo ${{ github.ref }} 

  #   # https://github.com/marketplace/actions/github-pull-request-action
  #   - name: Création de la pull request
  #     id: open-pr
  #     uses: peter-evans/create-pull-request@v7
  #     with:
  #       token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  #       commit-message: 'Envoi vers stage - Commit numéro: ${{github.sha}}'
  #       title: 'Envoi vers stage - Commit numéro: ${{github.sha}}'
  #       body: Test
  #       labels: feature, automated pr
  #       branch: features
  #       # base: ${{ github.ref }}
      
  # #   ###########################################################
  # #   # Job 3 Merger la branche de feature dans la branche main #
  # #   ###########################################################

  # merge_on_stage:
  #   needs: pull_request_features
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/features'
  #   # if: ${{ (github.event.review.state == 'approved') && (contains(github.event.pull_request.labels.*.name, 'test')) }}
  #   steps:

  #   # recupération du repository
  #   - name: git checkout
  #     uses: actions/checkout@v3
  #     with:
  #       token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

  #   # https://github.com/marketplace/actions/github-pull-request-action
  #   - name: Création de la pull request
  #     id: open-pr
  #     uses: peter-evans/create-pull-request@v7
  #     with:
  #       token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  #       commit-message: 'Envoi vers stage - Commit numéro: ${{github.sha}}'
  #       title: 'Envoi vers stage - Commit numéro: ${{github.sha}}'
  #       body: >
  #         This PR is auto-generated by 
  #         [create-pull-request](https://github.com/peter-evans/create-pull-request).
  #       labels: feature, automated pr
  #       branch: stage
  #       delete-branch: false
  #       # author: ${{ github.actor }}
  #       # assignees: Bahamut0
  #       # reviewers: Bahamut0

  #     # https://github.com/marketplace/actions/enable-pull-request-automerge
  #   - name: Activer la merge automatique
  #     if: steps.open-pr.outputs.pr_number != ''
  #     uses: peter-evans/enable-pull-request-automerge@v3
  #     with:
  #       token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  #       pull-request-number: ${{ steps.open-pr.outputs.pr_number }}
  #       merge-method: squash


  # #   ###########################################################
  # #   # Job 4 Merger la branche de stage dans la branche main #
  # #   ###########################################################

  # merge_on_main:
  #   needs: merge_on_stage
  #   runs-on: ubuntu-latest
  #   steps:

  #   # recupération du repository
  #   - name: git checkout
  #     uses: actions/checkout@v3
  #     with:
  #       token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

  #   # https://github.com/marketplace/actions/github-pull-request-action
  #   - name: Création de la pull request
  #     id: open-pr
  #     uses: peter-evans/create-pull-request@v7
  #     with:
  #       token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  #       commit-message: 'Envoi vers main - Commit numéro: ${{github.shar}}'
  #       title: 'Envoi vers main - Commit numéro: ${{github.sha}}'
  #       body: >
  #         This PR is auto-generated by 
  #         [create-pull-request](https://github.com/peter-evans/create-pull-request).
  #       labels: feature, automated pr
  #       branch: main

  #     # https://github.com/marketplace/actions/enable-pull-request-automerge
  #   - name: Activer la merge automatique
  #     if: steps.open-pr.outputs.pr_number != ''
  #     uses: peter-evans/enable-pull-request-automerge@v3
  #     with:
  #       token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  #       pull-request-number: ${{ steps.open-pr.outputs.pr_number }}
  #       merge-method: squash
        

      
  

      